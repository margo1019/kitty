KISSY.add("wb/manage/layout",function(S,D,E){var reAvailNodeName=/^(iframe|div|p|section)$/i,ATTR_LAYOUT="wb-layout",ATTR_LAYOUT_ID="wb-layout-id",atoms={0:{id:0}};function analyLayoutElement(ele){var idx=analyLayoutElement.idx++,config;ele.setAttribute(ATTR_LAYOUT_ID,idx);var atom=atoms[idx]=atoms[idx]||{};atom.id=idx;atom.node=ele;try{config=eval("("+D.attr(ele,ATTR_LAYOUT)+")")}catch(e){}config=S.merge({type:"row",control:false},config||{});config.width&&(config.width=parseDimensionRule(config.width));config.height&&(config.height=parseDimensionRule(config.height));atom.config=config;atom.parent=ele.parentNode.getAttribute(ATTR_LAYOUT_ID)||0;if("column"==config.type){D.css(ele,"float","left")}else{if("row"==config.type){D.css(ele,{"float":"static",display:"block"})}}return idx}analyLayoutElement.idx=1;function parseDimensionRule(str){var setting={unit:"px"};if(/^\d*$/.test(str)){setting.max=setting.min=str-0}else{if(~str.indexOf(",")){var x=str.split(",");if(2==x.length){setting.min=x[0]-0;setting.max=x[1]-0}}}return setting}function walkElement(context){context=D.get(context||document.body);if(!context){return}var ele=context.firstChild,hasFound=false,childLayoutIds=[],stack=[];while(ele){if(1==ele.nodeType&&reAvailNodeName.test(ele.nodeName)){if(hasFound||ele.getAttribute(ATTR_LAYOUT)){if(!hasFound){for(var i=0,len=stack.length;i<len;i++){childLayoutIds.push(analyLayoutElement(stack[i]))}hasFound=true}childLayoutIds.push(analyLayoutElement(ele))}stack.push(ele)}ele=ele.nextSibling}var layoutId=context.getAttribute(ATTR_LAYOUT_ID)||0;if(layoutId in atoms&&childLayoutIds.length){atoms[layoutId].child=childLayoutIds}for(var i=0,len=stack.length;i<len;i++){walkElement(stack[i])}}return{init:function(context){walkElement(context);var self=this;self.reflow();E.on(window,"resize",function(){self.reflow()})},reflow:function(layoutid){var root,rw,rh;if(layoutid in atoms){root=atoms[layoutid].node;rw=D.width(root);rh=D.height(root)}else{root=document.body;rw=D.viewportWidth();rh=D.viewportHeight()}var atom=atoms[root.getAttribute(ATTR_LAYOUT_ID)||0];if(atom&&atom.child){var child=atom.child,boxAtom,filltype,used=0,config,childAtom,node;for(var i=0,len=child.length;i<len;i++){childAtom=atoms[child[i]];if(childAtom){config=childAtom.config;if(!boxAtom&&"box"==config.type){boxAtom=childAtom;continue}if(!filltype){filltype="row"==config.type?"height":"width"}node=childAtom.node;if("width"==filltype){D.css(node,"height",rh);var width=D.width(node),widthConfig=config.width;if(widthConfig){width=Math.min(width,widthConfig.max);width=Math.max(width,widthConfig.min);node.style.width=width+"px"}used+=width}else{used+=D.height(node)}}}if(boxAtom){node=boxAtom.node;if("width"==filltype){D.css(node,"width",rw-used);D.css(node,"height",rh);D.css(node,"float","left")}else{D.css(node,"height",rh-used)}if("IFRAME"===node.nodeName){node.frameBorder="0"}}for(var i=0,len=child.length;i<len;i++){this.reflow(child[i])}}},addRow:function(el){},addColumn:function(el){}}},{requires:["dom","event"]});
